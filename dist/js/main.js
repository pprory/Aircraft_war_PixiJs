"use strict";var _createClass=function(){function a(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,e){return i&&a(t.prototype,i),e&&a(t,e),t}}();function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var _Main=null,app=void 0,su=void 0;function load(){app=new PIXI.Application({width:$(".app").width(),height:$(".app").height(),antialiasing:!0,transparent:!1,resolution:1}),su=new SpriteUtilities(PIXI),PIXI.loader.add(["images/snow.png","images/map2.jpg","images/ace.png","images/bullet.png","images/bullet2.png","images/bullet0.png","images/enemy1.png","images/boom.png","images/boss.png"]).load(function(){document.querySelector(".app").appendChild(app.view),(_Main=new Main).init(),$(".load-container").fadeOut(800,function(){}),$(".ranking-list-box").fadeIn(800),$(".start-btn").click(function(){0===_Main.integral.health?_Main.restart():_Main.start(),$(".ranking-list-box").hide()})}),PIXI.loader.onProgress.add(function(t,i){console.log("加载"+t.progress+"%"),$(".progress").html(t.progress.toFixed(2))})}var Main=function(){function t(){_classCallCheck(this,t),this.userName=localStorage.getItem("_userinfo")||null,this.container=new PIXI.Container,this.ParticleContainer=new PIXI.ParticleContainer,this.initYSpeed=1,this.snowPond=[],this.map=null,this.mapInit=null,this.aricraft=new Aricraft,this.aricraftSprite=this.aricraft.init(),this.aricraftHot={x:null,y:null},this.bullet=new Bullet,this.bulletArr=[],this.enemy=new Enemy,this.enemyArr=[],this.enemyRefreshSpeed=1e3,this.integral={value:0,health:100},this.healthColor={healthy:{r:2,g:190,b:25},enough:{r:173,g:198,b:34},general:{r:255,g:180,b:43},danger:{r:255,g:25,b:25}},this.timer=null,this.enemy_bulletArr=[],this.boom=new Boom,this.passIndex=1}return _createClass(t,[{key:"init",value:function(){var i=this;this.createMap(),this.createSnow(),this.setIntegral(0),app.stage.addChild(this.ParticleContainer),app.ticker.add(function(t){i.play()})}},{key:"start",value:function(){this.createAricraft(),this.aricraft.setInvincible(),this.createEnemy(),toast("游戏开始")}},{key:"play",value:function(){var e=this;this.snowPond.forEach(function(t){t.y+=t.width/5,t.x+=-.2,t.rotation+=.01+.01/t.width,t.ResetPosition(t)}),this.mapInit.tilePosition.y+=3,this.aricraftSprite.position.x+=this.aricraftSprite.vx,this.aricraftSprite.position.y+=this.aricraftSprite.vy,this.aricraftHot.x=this.aricraftSprite.position.x+this.aricraftSprite.width/2,this.aricraftHot.y=this.aricraftSprite.position.y+this.aricraftSprite.width/2,this.boundaryLimit(this.aricraftSprite),this.bulletArr.forEach(function(t,i){t.position.y+=t.vy,(t.isDest||t.position.y<0)&&(e.bulletArr.splice(i,1),e.container.removeChild(t))}),this.enemyArr.forEach(function(i,t){i.position.y+=i.vy,i.position.x+=i.vx,0===i.health&&(e.setIntegral(i.coin),i.alpha=0,e.enemyArr.splice(t,1),i.isBoos&&(clearInterval(i.timer),setTimeout(function(){e.createEnemy(e.enemyRefreshSpeed-=28)},1500)),e.boomPlay(i.position.x+i.width/2,i.position.y+i.height/2+15),e.ParticleContainer.removeChild(i)),i.position.y>$(".app").height()&&(e.container.removeChild(i),clearInterval(i.timer),e.enemyArr.splice(t,1)),i.position.x>$(".app").width()-i.width?i.vx=-.5:i.position.x<0&&(i.vx=.5),e.bulletArr.forEach(function(t){0!==i.health&&hitTestRectangle(t,i)&&(t.isDest=!0,--i.health)}),!e.aricraftSprite.isInvincible&&hitTestRectangle(i,e.aricraftHot)&&e.setHealth()}),this.enemy_bulletArr.forEach(function(t,i){t.position.x+=t.vx,t.position.y+=t.vy,(t.position.y>$(".app").height()+20||t.position.y<-20||t.position.x>$(".app").width()+20||t.position.x<-20)&&(e.enemy_bulletArr.splice(i,1),e.container.removeChild(t),e.ParticleContainer.removeChild(t)),t.isDest||e.aricraftSprite.isInvincible||!hitTestRectangle(t,e.aricraftHot)||(t.isDest=!0,e.enemy_bulletArr.splice(i,1),e.ParticleContainer.removeChild(t),e.container.removeChild(t),e.setHealth())})}},{key:"createSnow",value:function(){console.log("创建雪花");for(var t=new Snow,i=0;i<30;i++){var e=t.rendererSnow(Math.random()*$(".app").width()+30,-50,30*Math.random(),+Math.random());this.snowPond.push(e),this.container.addChild(e)}app.stage.addChild(this.container)}},{key:"createMap",value:function(){console.log("创建地图"),this.map=new Map,this.mapInit=this.map.init(),this.container.addChild(this.mapInit)}},{key:"createAricraft",value:function(){var r=this;this.aricraftSprite.scale.x=.6,this.aricraftSprite.scale.y=.6,this.aricraftSprite.position.x=$(".app").width()/2-this.aricraftSprite.width/2,this.aricraftSprite.position.y=$(".app").height()-this.aricraftSprite.height-30,this.aricraftSprite.width=.8*this.aricraftSprite.width,this.aricraftSprite.height=.8*this.aricraftSprite.height,this.container.addChild(this.aricraftSprite),this.aricraftSprite.interactive=!0,this.aricraftSprite.on("pointerdown",function(){var a=!0;r.aricraftSprite.on("pointermove",function(t){var i=t.data.global.x,e=t.data.global.y;r.aricraftSprite.position.set(i-r.aricraftSprite.width/2,e-r.aricraftSprite.height/2),a&&(a=!1,r.createBullet(),setTimeout(function(){a=!0},150))})}),this.aricraftSprite.on("pointerup",function(){r.aricraftSprite.removeListener("pointermove")}),this.aricraftHot=new PIXI.Graphics,this.aricraftHot.beginFill(),this.aricraftHot.drawCircle(0,0,17),this.aricraftHot.endFill(),this.aricraftHot.alpha=0,this.aricraftHot.x=this.aricraftSprite.position.x+30,this.aricraftHot.y=this.aricraftSprite.position.y+30,this.container.addChild(this.aricraftHot)}},{key:"createBullet",value:function(){var t=this.bullet.init();t.x=this.aricraftSprite.position.x+this.aricraftSprite.width/2-t.width/2,t.y=this.aricraftSprite.position.y-28,this.bulletArr.push(t),this.container.addChild(t)}},{key:"createEnemy",value:function(t){var i=this,e=0<arguments.length&&void 0!==t?t:this.enemyRefreshSpeed;this.timer=setInterval(function(){var t=i.enemy.init(50+Math.random()*$(".app").width()-70,-150);i.container.addChild(t),i.enemyArr.push(t),i.fire()},e)}},{key:"boundaryLimit",value:function(t){t.position.x+t.width>$(".app").width()&&(t.position.x=$(".app").width()-t.width),t.position.x<0&&(t.position.x=0),t.position.y+t.height>$(".app").height()&&(t.position.y=$(".app").height()-t.height)}},{key:"setIntegral",value:function(t){var i=this;this.integral.value+=t,$(".int-value").html(this.integral.value),calcRankingList(this.integral.value),this.integral.value%50==0&&0!==this.integral.value&&(clearInterval(this.timer),toast("第"+this.passIndex+"关boss即将上场"),this.passIndex++,setTimeout(function(){i.createBoss()},3e3))}},{key:"setHealth",value:function(){switch(this.integral.health){case 100:TweenMax.to(".health-value",1,{background:"rgb("+this.healthColor.enough.r+","+this.healthColor.enough.g+","+this.healthColor.enough.b+")"}),toast("请注意血量","rgba(255,66,66,0.8)","#fff");break;case 75:TweenMax.to(".health-value",1,{background:"rgb("+this.healthColor.general.r+","+this.healthColor.general.g+","+this.healthColor.general.b+")"}),toast("请注意血量","rgba(255,66,66,0.8)","#fff");break;case 50:TweenMax.to(".health-value",1,{background:"rgb("+this.healthColor.danger.r+","+this.healthColor.danger.g+","+this.healthColor.danger.b+")"}),toast("请注意血量","rgba(255,66,66,0.8)","#fff");break;case 25:this.gameover()}TweenMax.to(".health-value",1,{width:(this.integral.health-=25)+"%"}),this.aricraft.setInvincible()}},{key:"gameover",value:function(){var a=this;updataRankinglist(this.integral.value,this.userName,function(e){e.forEach(function(t,i){a.integral.value===t.coin&&($(".val1").html(i+1),$(".val2").html(e[i-1].coin-a.integral.value))})}),this.aricraftSprite.visible=!1,clearInterval(this.timer),$(".game-over").slideDown(800,function(){a.enemy_bulletArr.forEach(function(t,i){a.ParticleContainer.removeChild(t)}),a.enemyArr.forEach(function(t,i){a.container.removeChild(t)}),a.enemy_bulletArr=[],a.enemyArr=[]}),$(".show-list").click(function(){$(".game-over").hide(),$(".ranking-list-box").show()})}},{key:"fire",value:function(c,p,u,f,d,g){var v=this;this.enemyArr.forEach(function(t,i){var e=c||t.x+t.width/2+10,a=p||t.y+t.height/2+40,r=u||new PIXI.Sprite(PIXI.loader.resources["images/bullet2.png"].texture),n=Math.atan2(e-(v.aricraftSprite.x+v.aricraftSprite.width/2+10),a-(v.aricraftSprite.y+v.aricraftSprite.height/2)),o=f||5*-Math.cos(n),h=d||5*-Math.sin(n),s=g||n,l=v.bullet.init(r,20,20,o,h,-s);l.position.set(e,a),v.enemy_bulletArr.push(l),v.ParticleContainer.addChild(l)})}},{key:"restart",value:function(){var t=this;$(".game-over").slideUp(800,function(){t.integral.health=100,t.integral.value=0,t.setIntegral(0),t.createEnemy(),TweenMax.to(".health-value",.5,{width:t.integral.health+"%"}),TweenMax.to(".health-value",1,{background:"rgb("+t.healthColor.healthy.r+","+t.healthColor.healthy.g+","+t.healthColor.healthy.b+")"}),t.aricraftSprite.visible=!0,t.aricraftSprite.position.set($(".app").width()/2-t.aricraftSprite.width/2,$(".app").height()-t.aricraftSprite.height-30),t.aricraft.setInvincible()})}},{key:"boomPlay",value:function(t,i){var e=this,a=this.boom.play(t,i);this.container.addChild(a),setTimeout(function(){e.container.removeChild(a)},1e3)}},{key:"createBoss",value:function(){var o=this,h=this.enemy.boss($(".app").width()/2-112.5,-150);h.tint="0x"+Math.floor(16777216*Math.random()).toString(16),h.isBoos=!0,setTimeout(function(){h.vy=0,setTimeout(function(){h.vx=.5},500)},2400),h.timer=setInterval(function(){var t=PIXI.loader.resources["images/bullet2.png"].texture,i=PIXI.loader.resources["images/bullet0.png"].texture,e=o.bullet.init(new PIXI.Sprite(i),20,20,4.1,-.7,0);e.position.set(h.x+h.width/2-85,h.y+h.height/2+50),o.enemy_bulletArr.push(e),o.container.addChild(e);var a=o.bullet.init(new PIXI.Sprite(t),20,20,4.1,-.3,0);a.position.set(h.x+h.width/2-35,h.y+h.height/2+60),o.enemy_bulletArr.push(a),o.ParticleContainer.addChild(a);var r=o.bullet.init(new PIXI.Sprite(t),20,20,4.1,.3,0);r.position.set(h.x+h.width/2+15,h.y+h.height/2+60),o.enemy_bulletArr.push(r),o.ParticleContainer.addChild(r);var n=o.bullet.init(new PIXI.Sprite(i),20,20,4.1,.7,0);n.position.set(h.x+h.width/2+65,h.y+h.height/2+50),o.enemy_bulletArr.push(n),o.container.addChild(n)},600),this.container.addChild(h),this.enemyArr.push(h);var t={color:1};TweenMax.to(t,.6,{color:.6,repeat:3,onUpdate:function(){o.mapInit.alpha=t.color},yoyo:!0,yoyoEase:!0})}}]),t}();$(".restart").click(function(){_Main.restart()});